

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Accessory Diagnostics Service &mdash; HomeKit ADK  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/tabs.js"></script>
        <script src="_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Accessory Metrics Service" href="accessory_metrics.html" />
    <link rel="prev" title="ADK Migration Guide" href="migration_guide.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> HomeKit ADK
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="adk_architecture.html">ADK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="adk_directory_structure.html">ADK Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker with ADK</a></li>
</ul>
<p class="caption"><span class="caption-text">Step-by-step Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="raspi_setup.html">Raspberry Pi Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="bct.html">Bonjour Conformance Test (BCT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wac_on_raspberrypi.html">WAC on Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera_on_darwin.html">Camera on macOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting ADK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interact_with_applications.html">Interacting with ADK applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_unit_tests.html">Writing Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_adk.html">Debugging ADK Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">ADK Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accessory_development.html">Accessory Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_pairing.html">Accessory Pairing</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_authentication.html">Accessory Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning_tools.html">Provisioning Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="ADK_Memory_Usage_and_Requirements.html">Memory Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptographic Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="make_options.html">Compile Time Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_convention.html">Coding Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration_guide.html">ADK Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">HomeKit Services</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Accessory Diagnostics Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compile">Compile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run">Run</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementation-details">Implementation Details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#key-requirements">Key Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-information">Additional Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hap-implementation">HAP Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pal-implementation">PAL Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="accessory_metrics.html">Accessory Metrics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="adaptive_light.html">Adaptive Lighting Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="appletv_remote.html">Apple TV Remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="firmware_update.html">Firmware Update Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="homekit_bridge.html">HomeKit Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="ip_camera.html">IP Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="lock_profile.html">Lock Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="stateless_programmable_switch.html">Stateless Programmable Switch</a></li>
<li class="toctree-l1"><a class="reference internal" href="thread.html">HAP over Thread Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="wifi_reconfiguration_feature.html">WiFi Reconfiguration Service</a></li>
</ul>
<p class="caption"><span class="caption-text">PAL APIs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_api_docs/dir_PAL.html">Directory PAL</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">HomeKit ADK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Accessory Diagnostics Service</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/accessory_diagnostics.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="accessory-diagnostics-service">
<h1>Accessory Diagnostics Service<a class="headerlink" href="#accessory-diagnostics-service" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This service enables the retrieval of diagnostic data from the accessory. An accessory is responsible to capture and
upload the logs to a HomeKit controller. The zipped archive or text file will be displayed on a share sheet on an iOS
controller.
If manufacturer diagnostics is enabled for the accessory, the user will have an option to upload the logs to an
accessory vendor. The vendor URL to forward the logs is determined at the time of certification.</p>
<div class="section" id="compile">
<h3>Compile<a class="headerlink" href="#compile" title="Permalink to this headline">¶</a></h3>
<p>You must have all the <a class="reference internal" href="getting_started.html"><span class="doc">prerequisites</span></a> for your development platform to compile the ADK.
Once all the prerequisites are installed for your platform, run the following to compile ADK with the Accessory
Diagnostics feature:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-bWFjT1M=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="0">macOS</button><button aria-controls="panel-0-TGludXg=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-TGludXg=" name="TGludXg=" role="tab" tabindex="-1">Linux</button><button aria-controls="panel-0-UmFzcGJlcnJ5IFBp" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tab" tabindex="-1">Raspberry Pi</button><button aria-controls="panel-0-Tm9yZGljIG5SRjUy" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tab" tabindex="-1">Nordic nRF52</button></div><div aria-labelledby="tab-0-bWFjT1M=" class="sphinx-tabs-panel group-tab" id="panel-0-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><p>Enable diagnostics snapshot format - <em>zip</em> (default)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot format - <em>text</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">USE_DIAGNOSTICS_TEXT_FORMAT</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>ADK</em> (default)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>Manufacturer</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_DIAGNOSTICS_MANUFACTURER</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics service for BLE:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">PROTOCOLS</span><span class="o">=</span>BLE <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_HDS_TRANSPORT_OVER_HAP</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics service for Thread:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">PROTOCOLS</span><span class="o">=</span>THREAD <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_HDS_TRANSPORT_OVER_HAP</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-TGludXg=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><p>Enable diagnostics snapshot format - <em>zip</em> (default)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Linux <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot format - <em>text</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Linux <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">USE_DIAGNOSTICS_TEXT_FORMAT</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>ADK</em> (default)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Linux <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>Manufacturer</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Linux <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_DIAGNOSTICS_MANUFACTURER</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-UmFzcGJlcnJ5IFBp" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tabpanel" tabindex="0"><p>Enable diagnostics snapshot format - <em>zip</em> (default)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot format - <em>text</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">USE_DIAGNOSTICS_TEXT_FORMAT</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>ADK</em> (default)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>Manufacturer</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_DIAGNOSTICS_MANUFACTURER</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics service for BLE:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">PROTOCOLS</span><span class="o">=</span>BLE <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_HDS_TRANSPORT_OVER_HAP</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-Tm9yZGljIG5SRjUy" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tabpanel" tabindex="0"><p>Enable diagnostics snapshot format - <em>text</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>nRF52 <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_HDS_TRANSPORT_OVER_HAP</span><span class="o">=</span><span class="m">1</span> <span class="nv">USE_DIAGNOSTICS_TEXT_FORMAT</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>ADK</em> (default)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>nRF52 <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_HDS_TRANSPORT_OVER_HAP</span><span class="o">=</span><span class="m">1</span> <span class="nv">USE_DIAGNOSTICS_TEXT_FORMAT</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Enable diagnostics snapshot type - <em>Manufacturer</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>nRF52 <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_HDS_TRANSPORT_OVER_HAP</span><span class="o">=</span><span class="m">1</span> <span class="nv">USE_DIAGNOSTICS_TEXT_FORMAT</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_DIAGNOSTICS_MANUFACTURER</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>For Thread:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>nRF52 <span class="nv">PROTOCOLS</span><span class="o">=</span>THREAD <span class="nv">HAP_DIAGNOSTICS_SERVICE</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_HDS_TRANSPORT_OVER_HAP</span><span class="o">=</span><span class="m">1</span> <span class="nv">USE_DIAGNOSTICS_TEXT_FORMAT</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div></div>
</div>
<div class="section" id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p>Please follow instructions at <a class="reference external" href="getting_started.html#step-5-running-an-adk-application">Running an ADK Application</a> to
run an ADK sample application.</p>
</div>
</div>
<div class="section" id="implementation-details">
<h2>Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<div class="section" id="key-requirements">
<h3>Key Requirements<a class="headerlink" href="#key-requirements" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Vendors would need to comply with privacy guidelines for the logs to be included in Accessory Diagnostics.</p></li>
<li><p>Accessory diagnostics feature requires that the platform supports a file system to which the diagnostics file can be
written and persisted.</p></li>
<li><p>Accessory platform should support an archiving utility to be able to archive the logs before they are sent over to an
iOS device.</p></li>
<li><p>Size of zip file or text file may not exceed 5 MB.</p></li>
<li><p>Multiple simultaneous requests should not be allowed.</p></li>
<li><p>Only admin controllers can request for diagnostics logs.</p></li>
</ul>
</div>
<div class="section" id="additional-information">
<h3>Additional Information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Bytes are uploaded in payload data chunks of 400 KB for IP transport and 7 KB for Bluetooth and Thread transports.
Including URL parameters the packet size is configured to be at most <em>500 KB</em>. See <em>kHAPDiagnostics_NumChunkBytes</em>.
Specification mentions any value between <em>1 KB</em> and <em>900 KB</em> may be chosen. This parameter may need to be tweaked
based on transport type. This is not configurable by the accessory application.</p></li>
<li><p>HAP Log Capture:</p>
<ul>
<li><p>Diagnostics only provides ability to capture HAP logs to file. Other logs like pcap, system, etc. can still be sent
using Diagnostics but its capture is outside the scope of the sample implementation provided by ADK.</p></li>
<li><p>Captured HAP logs are persistent across crashes or app reboots.</p></li>
<li><p>Uses a rotation scheme of 10 log files to keep total HAP Log size below a configurable accessory specified value.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="hap-implementation">
<h3>HAP Implementation<a class="headerlink" href="#hap-implementation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><em>HAP+API.h</em></p>
<ul>
<li><p>Service and characteristics information</p></li>
<li><p>Diagnostics configuration structure</p>
<ul>
<li><p>Diagnostics snapshot format</p></li>
<li><p>Diagnostics snapshot type</p></li>
<li><p>Diagnostics snapshot options</p></li>
<li><p>Diagnostics supported mode</p></li>
<li><p>Diagnostics context</p></li>
</ul>
</li>
</ul>
</li>
<li><p><em>HAP/HAPDataStreamProtocols+DataSend.h</em> and <em>HAP/HAPDataStreamProtocols+DataSend.h</em></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPDataSendDataStreamProtocolSendData</span></code> dataSequenceNumber for packets and URL parameters</p></li>
<li><p>Added new optional reason “DiagnosticsData”</p></li>
</ul>
</li>
<li><p><em>HAP/HAPDiagnostics.h</em> and <em>HAP/HAPDiagnostics.c</em></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPDiagnosticsContext</span></code> structure</p>
<ul>
<li><p>Data Send stream context</p></li>
<li><p>Data Send scratch bytes</p></li>
<li><p>Other internal structures</p></li>
</ul>
</li>
<li><p><em>HAPDiagnosticsHandleDataSendStreamAvailable</em></p>
<ul>
<li><p>HDS callback function</p></li>
<li><p>Sets up dataSend stream &amp; context</p></li>
<li><p>Calls PAL API <code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsPrepareData</span></code> to collect logs and create a zip or text file in a separate
thread/process</p></li>
<li><p>Creates a timer to monitor data prepare operation</p></li>
<li><p>Rejects simultaneous requests</p></li>
</ul>
</li>
<li><p>Callback APIs for PAL to report status to HAP</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPDiagnosticsDataReady</span></code> called by PAL to report diagnostics file is ready</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPDiagnosticsDataCancel</span></code> called by PAL to report cancellation of data prepare operation</p></li>
</ul>
</li>
<li><p><em>HandleDataSendStreamClose</em></p>
<ul>
<li><p>HDS callback function</p></li>
<li><p>Clears Data Send stream context state and other internal flags</p></li>
</ul>
</li>
<li><p><em>UploadDiagnosticsData</em></p>
<ul>
<li><p>Calls into PAL to get the bytes to be uploaded</p></li>
<li><p>Creates Data send stream protocol packets and sends data using HAPDataSendDataStreamProtocolSendData</p></li>
</ul>
</li>
<li><p><em>HAPDiagnosticsSetupLogCaptureToFile</em> and <em>HAPDiagnosticsStopLogCaptureToFile</em></p>
<ul>
<li><p>Sets up &amp; stops capture of HAP log file</p></li>
<li><p>Calls into PAL APIs</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="pal-implementation">
<h3>PAL Implementation<a class="headerlink" href="#pal-implementation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><em>PAL/HAPPlatformDiagnostics.h</em> and <em>PAL/POSIX/HAPPlatformDiagnostics.c</em></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsInitialize</span></code> initializes diagnostics, creates diagnostics folders and starts capture of PAL
specific diagnostics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsDeinitialize</span></code> stops capture of PAL specific diagnostics and de-initializes diagnostics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsStartLogCaptureToFile</span></code> starts capturing logs to Diagnostics log file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsWriteToFile</span></code> function is called when HAP log API is called. When diagnostics logging is
enabled, HAP logs are written both to stderr and to file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsWriteToLogBuffer</span></code> function is called when HAP logs are to be written to a buffer instead
of a file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsGetBytesToUpload</span></code> reads chunk bytes from diagnostics file for HAP to upload.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsPrepareData</span></code> called by HAP to start the data collection operation asynchronously.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsDataTransferComplete</span></code> called by HAP to inform PAL that the data transfer is complete. PAL
may free up its resources.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsAbort</span></code> called by HAP to abort log collection as the data stream has been closed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsWriteToCrashLog</span></code> called by App if a segmentation fault is detected.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsClearCrashLog</span></code> called by App to clear the crash log.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformDiagnosticsWriteToConfigLog</span></code> called by HAP to log accessory configuration information.</p></li>
</ul>
</li>
<li><p><em>PAL/HAPPlatformDiagnosticsLog.h</em> and <em>PAL/POSIX/HAPPlatformDiagnosticsLog.c</em></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">DiagnosticsLog</span></code> context structure.</p></li>
<li><p>Handles rotation of log files to restrict total HAP log size.</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="accessory_metrics.html" class="btn btn-neutral float-right" title="Accessory Metrics Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="migration_guide.html" class="btn btn-neutral float-left" title="ADK Migration Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright © 2021 Apple Inc. All Rights Reserved..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>