

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Accessory Metrics Service &mdash; HomeKit ADK  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/tabs.js"></script>
        <script src="_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Adaptive Lighting Service" href="adaptive_light.html" />
    <link rel="prev" title="Accessory Diagnostics Service" href="accessory_diagnostics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> HomeKit ADK
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="adk_architecture.html">ADK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="adk_directory_structure.html">ADK Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker with ADK</a></li>
</ul>
<p class="caption"><span class="caption-text">Step-by-step Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="raspi_setup.html">Raspberry Pi Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="bct.html">Bonjour Conformance Test (BCT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wac_on_raspberrypi.html">WAC on Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera_on_darwin.html">Camera on macOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting ADK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interact_with_applications.html">Interacting with ADK applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_unit_tests.html">Writing Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_adk.html">Debugging ADK Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">ADK Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accessory_development.html">Accessory Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_pairing.html">Accessory Pairing</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_authentication.html">Accessory Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning_tools.html">Provisioning Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="ADK_Memory_Usage_and_Requirements.html">Memory Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptographic Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="make_options.html">Compile Time Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_convention.html">Coding Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration_guide.html">ADK Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">HomeKit Services</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="accessory_diagnostics.html">Accessory Diagnostics Service</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Accessory Metrics Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compile">Compile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run">Run</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementation-details">Implementation Details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#key-requirements">Key Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-information">Additional Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hap-implementation">HAP Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#app-implementation">App Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="adaptive_light.html">Adaptive Lighting Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="appletv_remote.html">Apple TV Remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="firmware_update.html">Firmware Update Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="homekit_bridge.html">HomeKit Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="ip_camera.html">IP Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="lock_profile.html">Lock Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="stateless_programmable_switch.html">Stateless Programmable Switch</a></li>
<li class="toctree-l1"><a class="reference internal" href="thread.html">HAP over Thread Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="wifi_reconfiguration_feature.html">WiFi Reconfiguration Service</a></li>
</ul>
<p class="caption"><span class="caption-text">PAL APIs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_api_docs/dir_PAL.html">Directory PAL</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">HomeKit ADK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Accessory Metrics Service</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/accessory_metrics.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="accessory-metrics-service">
<h1>Accessory Metrics Service<a class="headerlink" href="#accessory-metrics-service" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This feature enables an accessory to report metrics to an iOS device. Accessory metrics are collected and uploaded to
Apple Analytics system. This document describes the Accessory Metrics feature provided by the ADK and how to integrate
it into a HomeKit accessory.</p>
<div class="section" id="compile">
<h3>Compile<a class="headerlink" href="#compile" title="Permalink to this headline">¶</a></h3>
<p>You must have all the <a class="reference internal" href="getting_started.html"><span class="doc">prerequisites</span></a> for your development platform to compile the ADK.
Once all the prerequisites are installed for your platform, run the following to compile ADK with the Accessory Metrics
feature:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-bWFjT1M=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="0">macOS</button><button aria-controls="panel-0-TGludXg=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-TGludXg=" name="TGludXg=" role="tab" tabindex="-1">Linux</button><button aria-controls="panel-0-UmFzcGJlcnJ5IFBp" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tab" tabindex="-1">Raspberry Pi</button><button aria-controls="panel-0-Tm9yZGljIG5SRjUy" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tab" tabindex="-1">Nordic nRF52</button></div><div aria-labelledby="tab-0-bWFjT1M=" class="sphinx-tabs-panel group-tab" id="panel-0-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">USE_ACCESSORY_METRICS</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-TGludXg=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Linux <span class="nv">USE_ACCESSORY_METRICS</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-UmFzcGJlcnJ5IFBp" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">USE_ACCESSORY_METRICS</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-Tm9yZGljIG5SRjUy" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tabpanel" tabindex="0"><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is currently not supported on this platform.</p>
</div>
</div></div>
</div>
<div class="section" id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p>Please follow instructions at <a class="reference external" href="getting_started.html#step-5-running-an-adk-application">Running an ADK Application</a> to
run an ADK sample application.</p>
</div>
</div>
<div class="section" id="implementation-details">
<h2>Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<div class="section" id="key-requirements">
<h3>Key Requirements<a class="headerlink" href="#key-requirements" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The accessory may choose to only report metric events defined in <em>HAPMetricEvent.h</em>.</p></li>
<li><p>A batch of metric data packets are sent every <em>60 seconds</em> to a connected controller via an open HDS session.</p></li>
<li><p>Multiple simultaneous HDS metrics sessions is not allowed.</p></li>
<li><p>Only admin controllers can request for metrics data.</p></li>
</ul>
</div>
<div class="section" id="additional-information">
<h3>Additional Information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Metrics events are sent as binary data packets over HDS. Each data packet is a metric event of type TLV8.</p></li>
<li><p>Each supported metric event is described in <em>HAPMetricEvent.h</em>. Unsupported metric events must not be sent.</p></li>
<li><p>The maximum queue size to store metric events is defined by <code class="docutils literal notranslate"><span class="pre">kHAPMetrics_MaxStoredEvents</span></code>. The default value is 50 events.
This value can be overridden at compile time using the option HAP_METRICS_MAX_STORED_EVENTS. Every
<code class="docutils literal notranslate"><span class="pre">kHAPMetrics_SendInterval</span></code> seconds the data in this queue is sent over HDS and flushed.</p></li>
<li><p>The TLV8 packet data for each metric event should not exceed <code class="docutils literal notranslate"><span class="pre">kHAPMetrics_MaxEventBytes</span></code> bytes.</p></li>
<li><p>The accessory will provide a list of supported metrics to an admin controller using the Supported Metrics
characteristic. The controller may choose to override the default reporting status of the metric.</p></li>
<li><p>The controller may choose to enable or disable all metrics collection via the Active characteristic .</p></li>
</ul>
</div>
<div class="section" id="hap-implementation">
<h3>HAP Implementation<a class="headerlink" href="#hap-implementation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><em>HAPMetricsEvent.h</em> and <em>HAPMetricEvent.c</em></p>
<ul>
<li><p>Metric event definitions.</p></li>
<li><p>Metric event setup APIs.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPMetricsEventInitialize</span></code> - Initialize a single metric event.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPMetricsEventSetFieldValue</span></code> - Set values for members of the metric event.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPMetricsEventEncodeTLV</span></code> - Encode the metric event to TLV.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><em>HAPMetrics.h</em> and <em>HAPMetrics.c</em></p>
<ul>
<li><p>Manages metrics event queue.</p></li>
<li><p>Sends data over HDS to controller.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPMetricsSubmitMetricEvent</span></code> - Submit metric event to the metric queue.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPMetricsDeleteMetricsEvents</span></code> - Deletes all previously queued metric events of a specific metric ID.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPMetricsDeleteAllMetricEvents</span></code> - Deletes all previously queued metric events.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="app-implementation">
<h3>App Implementation<a class="headerlink" href="#app-implementation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><em>MetricsHelper.h</em> and <em>MetricsHelper.c</em></p>
<ul>
<li><p>Calls HAP APIs to initialize and de-initialize metrics framework.</p></li>
<li><p>Implements read and write handlers for the Accessory Metrics Characteristics.</p></li>
</ul>
</li>
<li><p><em>MetricsServiceDB.h</em> and <em>MetricsServiceDB.c</em></p>
<ul>
<li><p>Accessory Metrics service and Characteristics configuration.</p></li>
<li><p>Service and Characteristics IIDs.</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="adaptive_light.html" class="btn btn-neutral float-right" title="Adaptive Lighting Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="accessory_diagnostics.html" class="btn btn-neutral float-left" title="Accessory Diagnostics Service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright © 2021 Apple Inc. All Rights Reserved..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>