

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Writing Unit Tests &mdash; HomeKit ADK  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Debugging ADK Applications" href="debug_adk.html" />
    <link rel="prev" title="Troubleshooting ADK" href="troubleshooting.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> HomeKit ADK
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="adk_architecture.html">ADK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="adk_directory_structure.html">ADK Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker with ADK</a></li>
</ul>
<p class="caption"><span class="caption-text">Step-by-step Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="raspi_setup.html">Raspberry Pi Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="bct.html">Bonjour Conformance Test (BCT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wac_on_raspberrypi.html">WAC on Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera_on_darwin.html">Camera on macOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting ADK</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="interact_with_applications.html">Interacting with ADK applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting ADK</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing Unit Tests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#header-files">Header files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-case-declaration">Test case declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#main-function">Main function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-setup-and-teardown">Test setup and teardown</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-assertion-macros">Test assertion macros</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running-tests">Running tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-a-subset-of-tests">Running a subset of tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-report">Test report</a></li>
<li class="toctree-l3"><a class="reference internal" href="#suppressing-happlatformabort-remapping">Suppressing HAPPlatformAbort() remapping</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-mocks">Using mocks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preparing-a-mock-framework">Preparing a mock framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-mocks-in-the-tests">Using mocks in the tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#declaring-mock-instance">Declaring mock instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-expectations">Setting up expectations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#return-value-overriding">Return value overriding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limiting-the-behavior-changes-to-a-certain-number-of-calls">Limiting the behavior changes to a certain number of calls.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verifying-number-of-calls-to-the-mock-function">Verifying number of calls to the mock function.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#argument-match">Argument match</a></li>
<li class="toctree-l4"><a class="reference internal" href="#always">ALWAYS()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#global-mock-objects">Global mock objects</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="debug_adk.html">Debugging ADK Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">ADK Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accessory_development.html">Accessory Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_pairing.html">Accessory Pairing</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_authentication.html">Accessory Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning_tools.html">Provisioning Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="ADK_Memory_Usage_and_Requirements.html">Memory Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptographic Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="make_options.html">Compile Time Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_convention.html">Coding Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration_guide.html">ADK Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">HomeKit Services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accessory_diagnostics.html">Accessory Diagnostics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_metrics.html">Accessory Metrics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="adaptive_light.html">Adaptive Lighting Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="appletv_remote.html">Apple TV Remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="firmware_update.html">Firmware Update Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="homekit_bridge.html">HomeKit Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="ip_camera.html">IP Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="lock_profile.html">Lock Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="stateless_programmable_switch.html">Stateless Programmable Switch</a></li>
<li class="toctree-l1"><a class="reference internal" href="thread.html">HAP over Thread Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="wifi_reconfiguration_feature.html">WiFi Reconfiguration Service</a></li>
</ul>
<p class="caption"><span class="caption-text">PAL APIs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_api_docs/dir_PAL.html">Directory PAL</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">HomeKit ADK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Writing Unit Tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/writing_unit_tests.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-unit-tests">
<h1>Writing Unit Tests<a class="headerlink" href="#writing-unit-tests" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><em>Tests/Harness</em> includes C++ header files as unit test framework, such as follows:</p>
<ul class="simple">
<li><p><em>UnitTestFramework.h</em> provides macros to organize tests in a test file to generate a test report in a common format.</p></li>
<li><p><em>HAPPlatform…Mock.h</em> files provide mock utilities to use mock functions and to modify the mock function behaviors.</p></li>
</ul>
<p>This document explains how to write ADK unit tests using those header files.</p>
<div class="section" id="header-files">
<h3>Header files<a class="headerlink" href="#header-files" title="Permalink to this headline">¶</a></h3>
<p>An ADK unit test must be created as a C++ source file with <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> extension in the <code class="docutils literal notranslate"><span class="pre">Tests</span></code> directory.
Include <code class="docutils literal notranslate"><span class="pre">Harness/UnitTestFramework.h</span></code> file after including relevant HAP and HAP Platform includes,
such as <code class="docutils literal notranslate"><span class="pre">HAPPlatform+Init.h</span></code> and <code class="docutils literal notranslate"><span class="pre">HAP+API.h</span></code>.</p>
<p>In addition, if a mock framework is used, define its assertion macro <code class="docutils literal notranslate"><span class="pre">MOCK_ASSERT</span></code> to use test assertion macro
<code class="docutils literal notranslate"><span class="pre">TEST_ASSERT</span></code> provided by the unit test framework, as in the following example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;HAP+API.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Harness/UnitTestFramework.h&quot;</span><span class="cp"></span>

<span class="c1">// Use test framework assert macro for mock framework asserts</span>
<span class="cp">#define MOCK_ASSERT TEST_ASSERT</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Harness/HAPPlatformBLEMock.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="section" id="test-case-declaration">
<h3>Test case declaration<a class="headerlink" href="#test-case-declaration" title="Permalink to this headline">¶</a></h3>
<p>A test file, which can be called a test suite, may contain multiple test cases.
Each of your test case function must be declared as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TEST</span><span class="p">(</span><span class="n">MyTestCaseName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">....</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="main-function">
<h3>Main function<a class="headerlink" href="#main-function" title="Permalink to this headline">¶</a></h3>
<p>Your main function must include <em>EXECUTE_TESTS(argc, (const char</em>*) argv)* call.
And the return value from the macro should be used to return from <em>main()</em>, for example, as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">HAPPlatformCreate</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXECUTE_TESTS</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><em>Note</em>: Typecast of <code class="docutils literal notranslate"><span class="pre">(const</span> <span class="pre">char**)</span></code> is required because C++ is strict on the type qualifier <em>const</em> as well.</p>
</div>
<div class="section" id="test-setup-and-teardown">
<h3>Test setup and teardown<a class="headerlink" href="#test-setup-and-teardown" title="Permalink to this headline">¶</a></h3>
<p>If you have either a common setup procedure or a common teardown procedure or both for all test cases
in your test file, you can declare <code class="docutils literal notranslate"><span class="pre">TEST_SETUP()</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code> or <code class="docutils literal notranslate"><span class="pre">TEST_TEARDOWN()</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code> or both.</p>
<p>For example,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_SETUP</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Clear all pairings</span>
<span class="w">    </span><span class="n">HAPError</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAPPlatformKeyValueStorePurgeDomain</span><span class="p">(</span><span class="n">platform</span><span class="p">.</span><span class="n">keyValueStore</span><span class="p">,</span><span class="w"> </span><span class="n">kHAPKeyValueStoreDomain_Pairings</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">TEST_ASSERT_EQUAL</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">kHAPError_None</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">TEST_TEARDOWN</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Clears all timers, hopefully, by advancing an hour.</span>
<span class="w">    </span><span class="n">HAPPlatformClockAdvance</span><span class="p">(</span><span class="n">HAPMinute</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="test-assertion-macros">
<h3>Test assertion macros<a class="headerlink" href="#test-assertion-macros" title="Permalink to this headline">¶</a></h3>
<p>The test framework provides a few assert macros such as:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_ASSERT(expression)</span></code> asserts that the <em>expression</em> is true.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_EQUAL(expression1,</span> <span class="pre">expression2)</span></code> asserts that <em>expression1</em> is equal to <em>expression2</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_NE(expression1,</span> <span class="pre">expression2)</span></code> asserts that <em>expression1</em> does not equal <em>expression2</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_EQUAL()</span></code> and <code class="docutils literal notranslate"><span class="pre">TEST_ASSERT_NE()</span></code> macros support integer types such as <code class="docutils literal notranslate"><span class="pre">int64_t</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code> and <code class="docutils literal notranslate"><span class="pre">double</span></code>
and null-terminated strings. All pointers will be considered as null-terminated strings.</p></li>
</ul>
<p><em>NOTE:</em> <code class="docutils literal notranslate"><span class="pre">HAPAssert()</span></code> macro can still be used but in some condition it may fail the entire test suite without generating
report. Hence, it is recommended to use above macros in your test functions.</p>
</div>
</div>
<div class="section" id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<div class="section" id="running-a-subset-of-tests">
<h3>Running a subset of tests<a class="headerlink" href="#running-a-subset-of-tests" title="Permalink to this headline">¶</a></h3>
<p>You can pass each test names within <code class="docutils literal notranslate"><span class="pre">TEST()</span></code> parentheses as arguments to the test executable
in order to test a subset of test, e.g.,</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>Output/Darwin-x86_64-apple-darwin19.3.0/Test/Tests/UnitTestAssertMacrosFailureTest.OpenSSL TestHapAssert TestAssertEqualDouble
</pre></div>
</div>
<p>The above will only execute the two tests: <code class="docutils literal notranslate"><span class="pre">TestHapAssert</span></code> and <code class="docutils literal notranslate"><span class="pre">TestAssertEqualDouble</span></code>.</p>
</div>
<div class="section" id="test-report">
<h3>Test report<a class="headerlink" href="#test-report" title="Permalink to this headline">¶</a></h3>
<p>At the end of a test, you will get a report like the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> <span class="o">=======================================================</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>  Test Results : Tests/MockTest.cpp
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Passed tests: <span class="m">2</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Failed tests: <span class="m">0</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Missing tests: <span class="m">0</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -------------------------------------------------------
</pre></div>
</div>
<p>It reports number of passed tests, number of failed tests and number of missing tests. Missing tests are tests which
cannot be found and they would occur only when test names are passed when executing the test executable, e.g.,</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ Output/Darwin-x86_64-apple-darwin19.3.0/Test/Tests/MockTest.OpenSSL BadTestName
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> <span class="o">=======================================================</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>  Test Results : Tests/MockTest.cpp
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Passed tests: <span class="m">0</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Failed tests: <span class="m">0</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Missing tests: <span class="m">1</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>  Missing Tests
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     BadTestName
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -------------------------------------------------------
</pre></div>
</div>
<p>When test fails, the failure messages are printed within the report, as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ Output/Darwin-x86_64-apple-darwin19.3.0/Test/Tests/UnitTestAssertMacrosFailureTest.OpenSSL
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> *******************************************************************************
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span>  Note that failures are expected <span class="k">for</span> <span class="nb">test</span> suite: Tests/UnitTestAssertMacrosFailureTest.cpp
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span>  Ignore the error messages.
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> *******************************************************************************
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestHapAssert
--------------------------------------------------------------------------------
<span class="m">0</span>.000	Fault	precondition failed: byteIndex &lt; numBytes - HAPBitSetContains
--------------------------------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestHapAssert
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssert
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT<span class="o">(</span><span class="nb">false</span><span class="o">)</span> failed @ Tests/UnitTestAssertMacrosFailureTest.cpp:72
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssert
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssertEqualLong
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT_EQUAL<span class="o">(</span><span class="m">1</span>, <span class="m">2</span><span class="o">)</span> failed: <span class="m">1</span> !<span class="o">=</span> <span class="m">2</span> @ Tests/UnitTestAssertMacrosFailureTest.cpp:77
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssertEqualLong
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssertEqualDouble
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT_EQUAL<span class="o">(</span><span class="m">1</span>.0, <span class="m">2</span>.0<span class="o">)</span> failed: <span class="m">1</span> !<span class="o">=</span> <span class="m">2</span> @ Tests/UnitTestAssertMacrosFailureTest.cpp:82
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssertEqualDouble
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssertEqualString
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT_EQUAL<span class="o">(</span><span class="s2">&quot;Foo&quot;</span>, <span class="s2">&quot;Bar&quot;</span><span class="o">)</span> failed: <span class="s2">&quot;Foo&quot;</span> &lt;&gt; <span class="s2">&quot;Bar&quot;</span> @ Tests/UnitTestAssertMacrosFailureTest.cpp:87
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssertEqualString
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssertNotEqualLong
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT_NE<span class="o">(</span><span class="m">1</span>, <span class="m">1</span><span class="o">)</span> failed: <span class="m">1</span> both @ Tests/UnitTestAssertMacrosFailureTest.cpp:92
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssertNotEqualLong
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssertNotEqualDouble
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT_NE<span class="o">(</span><span class="m">2</span>.0, <span class="m">2</span>.0<span class="o">)</span> failed: <span class="m">2</span> both @ Tests/UnitTestAssertMacrosFailureTest.cpp:97
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssertNotEqualDouble
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssertNotEqualString
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT_NE<span class="o">(</span><span class="s2">&quot;Foo&quot;</span>, <span class="s2">&quot;Foo&quot;</span><span class="o">)</span> failed: <span class="s2">&quot;Foo&quot;</span> both @ Tests/UnitTestAssertMacrosFailureTest.cpp:102
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssertNotEqualString
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestAssertWithinMock
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT<span class="o">(</span>!failIt<span class="o">)</span> failed @ Tests/UnitTestAssertMacrosFailureTest.cpp:111
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestAssertWithinMock
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Starts - TestMockVerification
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Tests/UnitTestAssertMacrosFailureTest.cpp:126 expected at least <span class="m">1</span> calls but called only <span class="m">0</span> times.
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> &lt;<span class="o">==</span> <span class="k">for</span> HAPPlatformServiceDiscoveryGetPort<span class="o">()</span>
<span class="m">0</span>.000	Error	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> TEST_ASSERT<span class="o">((</span>mock<span class="o">)</span>.VerifyAll<span class="o">())</span> failed @ Tests/UnitTestAssertMacrosFailureTest.cpp:129
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:UnitTest<span class="o">]</span> Test Ends - TestMockVerification
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> <span class="o">=================================================================</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>  Test Results : Tests/UnitTestAssertMacrosFailureTest.cpp
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>  Note that this <span class="nb">test</span> suite expected all tests to fail.
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -----------------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Passed tests: <span class="m">0</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Failed tests: <span class="m">10</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>   Missing tests: <span class="m">0</span>
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -----------------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>  Failed Tests
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -----------------------------------------------------------------
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestHapAssert : Platform Aborted
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssert : TEST_ASSERT<span class="o">(</span><span class="nb">false</span><span class="o">)</span> failed @ Tests/UnitTestAssertMacrosFailureTest.cpp:72
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssertEqualLong : TEST_ASSERT_EQUAL<span class="o">(</span><span class="m">1</span>, <span class="m">2</span><span class="o">)</span> failed: <span class="m">1</span> !<span class="o">=</span> <span class="m">2</span> @ Tests/UnitTestAssertMacrosFailureTest.cpp:77
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssertEqualDouble : TEST_ASSERT_EQUAL<span class="o">(</span><span class="m">1</span>.0, <span class="m">2</span>.0<span class="o">)</span> failed: <span class="m">1</span> !<span class="o">=</span> <span class="m">2</span> @ Tests/UnitTestAssertMacrosFailureTest.cpp:82
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssertEqualString : TEST_ASSERT_EQUAL<span class="o">(</span><span class="s2">&quot;Foo&quot;</span>, <span class="s2">&quot;Bar&quot;</span><span class="o">)</span> failed: <span class="s2">&quot;Foo&quot;</span> &lt;&gt; <span class="s2">&quot;Bar&quot;</span> @ Tests/UnitTestAssertMacrosFailureTest.cpp:87
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssertNotEqualLong : TEST_ASSERT_NE<span class="o">(</span><span class="m">1</span>, <span class="m">1</span><span class="o">)</span> failed: <span class="m">1</span> both @ Tests/UnitTestAssertMacrosFailureTest.cpp:92
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssertNotEqualDouble : TEST_ASSERT_NE<span class="o">(</span><span class="m">2</span>.0, <span class="m">2</span>.0<span class="o">)</span> failed: <span class="m">2</span> both @ Tests/UnitTestAssertMacrosFailureTest.cpp:97
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssertNotEqualString : TEST_ASSERT_NE<span class="o">(</span><span class="s2">&quot;Foo&quot;</span>, <span class="s2">&quot;Foo&quot;</span><span class="o">)</span> failed: <span class="s2">&quot;Foo&quot;</span> both @ Tests/UnitTestAssertMacrosFailureTest.cpp:102
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestAssertWithinMock : TEST_ASSERT<span class="o">(</span>!failIt<span class="o">)</span> failed @ Tests/UnitTestAssertMacrosFailureTest.cpp:111
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span>     TestMockVerification : TEST_ASSERT<span class="o">((</span>mock<span class="o">)</span>.VerifyAll<span class="o">())</span> failed @ Tests/UnitTestAssertMacrosFailureTest.cpp:129
<span class="m">0</span>.000	Default	<span class="o">[</span>com.apple.mfi.HomeKit.Core.Test:Report<span class="o">]</span> -----------------------------------------------------------------
</pre></div>
</div>
<p>Each failed test start with the test case name and the actual failure message separated by a colon.
When you get a <em>Platform Aborted</em> message, you will have to look at the test log to find out where the problem occurred.
You’ll have to look at the test logs for mock verification failure as well as it provides the line where the expectation was set.</p>
</div>
<div class="section" id="suppressing-happlatformabort-remapping">
<h3>Suppressing HAPPlatformAbort() remapping<a class="headerlink" href="#suppressing-happlatformabort-remapping" title="Permalink to this headline">¶</a></h3>
<p>Test framework re-implements <code class="docutils literal notranslate"><span class="pre">HAPPlatformAbort()</span></code> function to be able to generate a test report at the end.
The function is implemented using C++ exceptions for platforms that support C++ exceptions. However, there are platforms
that do not support C++ exceptions, most likely because of the cost of exceptions. In such a case, the function is
implemented with long jumps. Long jump behavior is undefined if the long jump occurs across threads.
Hence, it is unsafe to keep the <code class="docutils literal notranslate"><span class="pre">HAPPlatformAbort()</span></code> implementation if you expect that some assertions could be called
from within functions which are not running on the same thread as the test suite itself.</p>
<p>Note that in general, the test framework doesn’t support thread-safety, which means that tests and test assertion macros
must be used on the same thread. That said, the intention wasn’t to prevent <code class="docutils literal notranslate"><span class="pre">HAPAssert()</span></code> from being called by another
thread.</p>
</div>
</div>
<div class="section" id="using-mocks">
<h2>Using mocks<a class="headerlink" href="#using-mocks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="preparing-a-mock-framework">
<h3>Preparing a mock framework<a class="headerlink" href="#preparing-a-mock-framework" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Tests/Harness/HAPPlatform...Mock.h</span></code> files are already configured for certain PAL functions
but not all functions yet. In order to mock a new set of functions, use one of those header files as a template
and create a new header file if necessary.</p>
<p>Mock function must be declared as part of <code class="docutils literal notranslate"><span class="pre">MOCK_FUNCS</span></code> macro in this file with spaces
between them. Note that function declarations must not be separated with a comma or any
other symbols.
Each mock function is declared with either of the following formats in <code class="docutils literal notranslate"><span class="pre">MOCK_FUNCS</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MOCK_FUNC_DEF(return_type,</span> <span class="pre">func_name,</span> <span class="pre">arguments,</span> <span class="pre">default_return_value)</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">return_type</span></code> shall be the type of the return value of the function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">func_name</span></code> is the name of the function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_return_value</span></code> is the default return value the mock function should return when the return value is not set during testing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arguments</span></code> must be in one of the following formats:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">MOCK_VOID_FUNC_DEF(func_name,</span> <span class="pre">arguments)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MOCK_ARGS(MOCK_ARG(argument_type,</span> <span class="pre">argument_name),</span> <span class="pre">...)</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">argument_type</span></code> is the type of the argument</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">argument_name</span></code> is the name of the argument</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">MOCK_VOID_ARG</span></code> is used if the argument type is void</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MOCK_NO_ARGS</span></code> is used when there are not arguments</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Note that since mock function mock a C function there is actually no difference between <code class="docutils literal notranslate"><span class="pre">MOCK_VOID_ARG</span></code> and <code class="docutils literal notranslate"><span class="pre">MOCK_NO_ARGS</span></code>.
Now, let’s look at a hypothetical example function you want to mock:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAPError</span><span class="w"> </span><span class="nf">HAPPlatformSetGPIOMode</span><span class="p">(</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformGPIOMode</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The mock declaration should look as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">MOCK_FUNC_DEF</span><span class="p">(</span><span class="n">HAPError</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">MOCK_ARGS</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">MOCK_ARG</span><span class="p">(</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">pin</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">MOCK_ARG</span><span class="p">(</span><span class="n">HAPPlatformGPIOMode</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="n">kHAPError_None</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Let’s look at another example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">HAPPlatformSetGPIOValue</span><span class="p">(</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Its mock declaration should look as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">MOCK_VOID_FUNC_DEF</span><span class="p">(</span><span class="n">HAPPlatformSetGPIOValue</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">MOCK_ARGS</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">MOCK_ARG</span><span class="p">(</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">MOCK_ARG</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
<p>When adding a function to mock, the function could be added to the existing <code class="docutils literal notranslate"><span class="pre">MOCK_FUNCS</span></code> definition in the <code class="docutils literal notranslate"><span class="pre">Tests/Harness/HAPPlatformBLEMock.h</span></code> or a new header file will be created based on the <code class="docutils literal notranslate"><span class="pre">Tests/Harness/HAPPlatformBLEMock.h</span></code> template.
In case of the latter, make sure that the following names must be renamed to your unique name.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformBLEMockMatchEntryStorages</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformBLEMock</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">globalHAPPlatformBLEMock</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAP_PLATFORM_BLE_MOCK</span></code></p></li>
</ul>
</div>
<div class="section" id="using-mocks-in-the-tests">
<h3>Using mocks in the tests<a class="headerlink" href="#using-mocks-in-the-tests" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to use mocks in each test.</p>
<ul class="simple">
<li><p>Test file must be C++ file with an extension of <code class="docutils literal notranslate"><span class="pre">.cpp</span></code>.</p></li>
<li><p>The mock header file must be included in the test after including all relevant HAP and HAP Platform headers.</p></li>
</ul>
<p>If <code class="docutils literal notranslate"><span class="pre">Tests/Harness/HAPPlatformBLEMock.h</span></code> is used, it would look like the following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;HAPPlatform+Init.h&quot;</span><span class="cp"></span>

<span class="cp">#include &quot;Harness/HAPPlatformBLEMock.h`</span>
</pre></div>
</div>
<div class="section" id="declaring-mock-instance">
<h4>Declaring mock instance<a class="headerlink" href="#declaring-mock-instance" title="Permalink to this headline">¶</a></h4>
<p>Mock instance will be created with a macro provided in your mock header file.
For example, in case of <code class="docutils literal notranslate"><span class="pre">Tests/Harness/HAPPlatformBLEMock.h</span></code>, the following macro will declare
a mock instance with the name <code class="docutils literal notranslate"><span class="pre">mock</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAP_PLATFORM_BLE_MOCK</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Normally you will use one mock instance of a mock type for your test.
However, if you create another instance of the same mock type, it will overwrite
all the previous mock behaviors until the newly created instance is destroyed.</p>
<p>Now you can pass the <code class="docutils literal notranslate"><span class="pre">mock</span></code> variable as a mock instance to one of the following macros
to modify the mock function behavior and to verify the mock function calls.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ALWAYS(mock_instance,</span> <span class="pre">function_name)</span></code>- Sets up an expectation that remains valid as far as mock instance is alive.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXPECT(mock_instance,</span> <span class="pre">function_name)</span></code>- Sets up an expectation that remains valid until the expectation is verified.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERIFY(mock_instance,</span> <span class="pre">function_name)</span></code>- Verifies all expectations associated with the function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERIFY_ALL(mock_instance)</span></code>- Verifies all expectations associated with the mock instance.</p></li>
</ul>
<p>Each macro usage is described in subsequent sections.</p>
</div>
<div class="section" id="setting-up-expectations">
<h4>Setting up expectations<a class="headerlink" href="#setting-up-expectations" title="Permalink to this headline">¶</a></h4>
<p>Either <code class="docutils literal notranslate"><span class="pre">ALWAYS()</span></code> macro or <code class="docutils literal notranslate"><span class="pre">EXPECT()</span></code> macro is used to set up expectation of a mock function call. Use <code class="docutils literal notranslate"><span class="pre">EXPECT()</span></code>
when trying to verify calls to the mock functions up to a certain point in the test. Use <code class="docutils literal notranslate"><span class="pre">ALWAYS()</span></code> in case you are
defining a mock function behavior throughout your test. The <code class="docutils literal notranslate"><span class="pre">EXPECT()</span></code> or <code class="docutils literal notranslate"><span class="pre">ALWAYS()</span></code> macros alone don’t do anything.
Either macro should be followed by method calls, i.e., <em>.MethodName()</em>, to define mock behavior or the mock function
call expectations.</p>
<p>The following methods are provided:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Return(T</span> <span class="pre">value)</span></code>: This method changes mock function behavior to return the designated value instead of
the default value setup in your mock header file. Note that this method is absent from void returning functions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Repeats(size_t</span> <span class="pre">n)</span></code>: This method constrains the mock function behaviors or the expectations to be valid
up to n calls to the mock function.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AtMost(size_t</span> <span class="pre">n)</span></code>: This method sets expectation that the mock function is called at most n times till the mock
function is verified. Only the calls within the constraint set by <code class="docutils literal notranslate"><span class="pre">Repeats()</span></code> or <code class="docutils literal notranslate"><span class="pre">If()</span></code> or both are counted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AtLeast(size_t</span> <span class="pre">n)</span></code>: This method sets expectation that the mock function is called at least n times till the mock
function is verified. Only the calls within the constraint set by <code class="docutils literal notranslate"><span class="pre">Repeats()</span></code> or <code class="docutils literal notranslate"><span class="pre">If()</span></code> or both are counted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">If(lambda_function)</span></code>: This method constrains the scope of expectation to the mock function calls with arguments that
will result in return value of true of the <code class="docutils literal notranslate"><span class="pre">lambda_function</span></code>. <code class="docutils literal notranslate"><span class="pre">lambda_function</span></code> takes the mock function call arguments
as its argument and returns either true or false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Do(lambda_function)</span></code>: This method changes mock function behavior to call the <code class="docutils literal notranslate"><span class="pre">lambda_function</span></code> with the mock function
arguments and to return the exact value <code class="docutils literal notranslate"><span class="pre">lambda_function</span></code> returns. Practically, the <code class="docutils literal notranslate"><span class="pre">lambda_function</span></code> replaces the mock
function. However, note that the <code class="docutils literal notranslate"><span class="pre">lambda_function</span></code> is triggered only within the constraints that are specified by either
<code class="docutils literal notranslate"><span class="pre">Repeats()</span></code> or <code class="docutils literal notranslate"><span class="pre">If()</span></code> or both method calls. That is, if expectation is configured to repeat only 1 time, the
<code class="docutils literal notranslate"><span class="pre">lambda_function</span></code> will be called only one time.</p></li>
</ul>
<p>The following sections describe in more detail how to use the macro and its methods.</p>
</div>
<div class="section" id="return-value-overriding">
<h4>Return value overriding<a class="headerlink" href="#return-value-overriding" title="Permalink to this headline">¶</a></h4>
<p>Let’s use the example of the hypothetical GPIO PAL functions above. If you want to override the return value of a
function, you can do the following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAP_PLATFORM_GPIO_MOCK</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_Unknown</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The above will make <code class="docutils literal notranslate"><span class="pre">HAPPlatformSetupGPIOMode()</span></code> function to return <code class="docutils literal notranslate"><span class="pre">kHAPPError_Unknown</span></code> until a verification
is done against that function. That is, until one of the following events:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VERIFY(mock,</span> <span class="pre">HAPPlatformSetGPIOMode)</span></code> is called.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERIFY_ALL(mock)</span></code> is called.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mock</span></code> goes out of scope.</p></li>
</ul>
</div>
<div class="section" id="limiting-the-behavior-changes-to-a-certain-number-of-calls">
<h4>Limiting the behavior changes to a certain number of calls.<a class="headerlink" href="#limiting-the-behavior-changes-to-a-certain-number-of-calls" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAP_PLATFORM_GPIO_MOCK</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_Unknown</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Repeats</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_InvalidData</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Repeats</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The above configuration will make <code class="docutils literal notranslate"><span class="pre">HAPPlatformSetGPIOMode()</span></code> to return <code class="docutils literal notranslate"><span class="pre">kHAPError_Unknown</span></code> four times
and then return <code class="docutils literal notranslate"><span class="pre">kHAPError_InvalidData</span></code> two times. Afterwards, the function will return default return value.</p>
<p>Note that if the mock function is verified before the designated number of calls were made, the configured number of
calls do not affect behaviors afterwards. That is, after verification, verified expectations are removed and hence they
are no longer effective.</p>
</div>
<div class="section" id="verifying-number-of-calls-to-the-mock-function">
<h4>Verifying number of calls to the mock function.<a class="headerlink" href="#verifying-number-of-calls-to-the-mock-function" title="Permalink to this headline">¶</a></h4>
<p>If you want to verify that a mock function was called certain number of times, you can use <code class="docutils literal notranslate"><span class="pre">AtMost()</span></code> and <code class="docutils literal notranslate"><span class="pre">AtLeast()</span></code> methods.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAP_PLATFORM_GPIO_MOCK</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtMost</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="n">VERIFY_ALL</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The above verifies that there is exactly one call to <code class="docutils literal notranslate"><span class="pre">HAPPlatformSetGPIOMode()</span></code> in the <em>…</em> region.</p>
</div>
<div class="section" id="argument-match">
<h4>Argument match<a class="headerlink" href="#argument-match" title="Permalink to this headline">¶</a></h4>
<p>Each expectation can be narrowly limited to certain argument values of mock function call.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAP_PLATFORM_GPIO_MOCK</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">If</span><span class="p">([](</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformGPIOMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_None</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_InvalidData</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtMost</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">VERIFY_ALL</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The above makes <code class="docutils literal notranslate"><span class="pre">HAPPlatformSetGPIOMOde()</span></code> to return <code class="docutils literal notranslate"><span class="pre">kHAPError_None</span></code> when pin index is 4 and otherwise,
<code class="docutils literal notranslate"><span class="pre">kHAPError_InvalidData</span></code>. It also sets up expectation that there has to be at least one call to <code class="docutils literal notranslate"><span class="pre">HAPPlatformSetGPIOMode()</span></code>
with the pin index 4 while no calls with other values are expected. Argument matching is evaluated in the order of macro calls.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">If</span></code> conditions also constrain the number of calls set up with <code class="docutils literal notranslate"><span class="pre">Repeats()</span></code>. That is, call to a mock
function with argument values that doesn’t match the <code class="docutils literal notranslate"><span class="pre">If</span></code> condition, will not be counted against the number of times
set up via <code class="docutils literal notranslate"><span class="pre">Repeats()</span></code> call.</p>
</div>
<div class="section" id="always">
<h4>ALWAYS()<a class="headerlink" href="#always" title="Permalink to this headline">¶</a></h4>
<p>Once the expectations are verified, the expectations and the mock function behaviors set up with <code class="docutils literal notranslate"><span class="pre">EXPECT()</span></code> are cleared.
Hence, it is important to set up expectations after verification.</p>
<p>However, you may want the same behavior of a mock function across the test and may not want to rewrite the expected
behavior of the mock function repeatedly after multiple verification points. In that case, you can use <code class="docutils literal notranslate"><span class="pre">ALWAYS()</span></code> macro
instead which remains valid till the mock instance itself is destroyed.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAP_PLATFORM_GPIO_MOCK</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Sets up the return values of HAPPlatformSetGPIOMode() which are applicable throughout the test</span>
<span class="n">ALWAYS</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">If</span><span class="p">([](</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformGPIOMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_None</span><span class="p">);</span><span class="w"></span>
<span class="n">ALWAYS</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_InvalidData</span><span class="p">).</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtMost</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// No pin-index != 4 call is expected throughout the test</span>

<span class="c1">// Until next verification, the following call is expected</span>
<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">If</span><span class="p">([](</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformGPIOMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kHAPPlatformGPIOMode_Output</span><span class="p">;</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">VERIFY_ALL</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Until next verification, the following call is not expected</span>
<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtMost</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">VERIFY_ALL</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Until next verification, the following call is expected</span>
<span class="n">EXPECT</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">If</span><span class="p">([](</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformGPIOMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kHAPPlatformGPIOMode_Input</span><span class="p">;</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">VERIFY_ALL</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="global-mock-objects">
<h4>Global mock objects<a class="headerlink" href="#global-mock-objects" title="Permalink to this headline">¶</a></h4>
<p>If you want to set up mocks in the same way for all your tests,
you should declare mock objects as global variables outside <code class="docutils literal notranslate"><span class="pre">TEST()</span></code> function and
configure such global mock objects in <code class="docutils literal notranslate"><span class="pre">TEST_SETUP()</span></code> function.</p>
<p>In such a case, make sure you call <code class="docutils literal notranslate"><span class="pre">Reset()</span></code> method for each global mock objects
in <code class="docutils literal notranslate"><span class="pre">TEST_TEARDOWN()</span></code>, in order to reset the internal states of all such mock objects.
Otherwise, one test would be affected by expectations set by another test.</p>
<p>The following is an example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">HAP_PLATFORM_GPIO_MOCK</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span><span class="w"></span>

<span class="n">TEST_SETUP</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ALWAYS</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformSetGPIOMode</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">If</span><span class="p">([](</span><span class="n">HAPPlatformGPIOPin</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">HAPPlatformGPIOMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">kHAPError_None</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">TEST_TEARDOWN</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// The following resets all expectations.</span>
<span class="w">    </span><span class="n">mock</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="debug_adk.html" class="btn btn-neutral float-right" title="Debugging ADK Applications" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="troubleshooting.html" class="btn btn-neutral float-left" title="Troubleshooting ADK" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright © 2021 Apple Inc. All Rights Reserved..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>