

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>WiFi Reconfiguration Service &mdash; HomeKit ADK  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/tabs.js"></script>
        <script src="_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Directory PAL" href="_api_docs/dir_PAL.html" />
    <link rel="prev" title="Thread Use Cases" href="Thread_Use_Case_Flows.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> HomeKit ADK
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="adk_architecture.html">ADK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="adk_directory_structure.html">ADK Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker with ADK</a></li>
</ul>
<p class="caption"><span class="caption-text">Step-by-step Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="raspi_setup.html">Raspberry Pi Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="bct.html">Bonjour Conformance Test (BCT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wac_on_raspberrypi.html">WAC on Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera_on_darwin.html">Camera on macOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting ADK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interact_with_applications.html">Interacting with ADK applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_unit_tests.html">Writing Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_adk.html">Debugging ADK Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">ADK Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accessory_development.html">Accessory Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_pairing.html">Accessory Pairing</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_authentication.html">Accessory Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning_tools.html">Provisioning Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="ADK_Memory_Usage_and_Requirements.html">Memory Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptographic Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="make_options.html">Compile Time Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_convention.html">Coding Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration_guide.html">ADK Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">HomeKit Services</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="accessory_diagnostics.html">Accessory Diagnostics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_metrics.html">Accessory Metrics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="adaptive_light.html">Adaptive Lighting Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="appletv_remote.html">Apple TV Remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="firmware_update.html">Firmware Update Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="homekit_bridge.html">HomeKit Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="ip_camera.html">IP Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="lock_profile.html">Lock Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="stateless_programmable_switch.html">Stateless Programmable Switch</a></li>
<li class="toctree-l1"><a class="reference internal" href="thread.html">HAP over Thread Profile</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">WiFi Reconfiguration Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#compile">Compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adk-implementation">ADK Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#implementation-details">Implementation details</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-update">Simple update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fail-safe-update">Fail safe update</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#hap-modules">HAP Modules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#source-files">Source files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pal-modules">PAL Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-wifi-reconfiguration">Testing WiFi Reconfiguration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#different-use-cases-to-test">Different use cases to test</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">PAL APIs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_api_docs/dir_PAL.html">Directory PAL</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">HomeKit ADK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>WiFi Reconfiguration Service</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/wifi_reconfiguration_feature.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="wifi-reconfiguration-service">
<h1>WiFi Reconfiguration Service<a class="headerlink" href="#wifi-reconfiguration-service" title="Permalink to this headline">¶</a></h1>
<p>This document describes the WiFi reconfiguration feature provided by the ADK and how to integrate it into a HomeKit
accessory. This feature enables an admin controller to reconfigure an accessory that is already configured on a WiFi
network to a new WiFi network.</p>
<div class="section" id="compile">
<h2>Compile<a class="headerlink" href="#compile" title="Permalink to this headline">¶</a></h2>
<p>You must have all the <a class="reference internal" href="getting_started.html"><span class="doc">prerequisites</span></a> for your development platform to compile the ADK. Once all the
prerequisites are installed for your platform, run the following to compile ADK with WiFi reconfiguration feature:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-bWFjT1M=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="0">macOS</button><button aria-controls="panel-0-TGludXg=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-TGludXg=" name="TGludXg=" role="tab" tabindex="-1">Linux</button><button aria-controls="panel-0-UmFzcGJlcnJ5IFBp" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tab" tabindex="-1">Raspberry Pi</button><button aria-controls="panel-0-Tm9yZGljIG5SRjUy" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tab" tabindex="-1">Nordic nRF52</button></div><div aria-labelledby="tab-0-bWFjT1M=" class="sphinx-tabs-panel group-tab" id="panel-0-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is currently not supported on this platform.</p>
</div>
</div><div aria-labelledby="tab-0-TGludXg=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is currently not supported on this platform.</p>
</div>
</div><div aria-labelledby="tab-0-UmFzcGJlcnJ5IFBp" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">USE_WAC</span><span class="o">=</span><span class="m">1</span> <span class="nv">HAP_WIFI_RECONFIGURATION</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-Tm9yZGljIG5SRjUy" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tabpanel" tabindex="0"><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is currently not supported on this platform.</p>
</div>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p><em>USE_WAC</em> should be used in combination with <em>HAP_WIFI_RECONFIGURATION</em> as there is some dependency on WAC code.</p></li>
<li><p>WAC requires ADK application to be configured for Hardware or Software Authentication. Please read
<a class="reference internal" href="accessory_authentication.html"><span class="doc">Accessory Authentication</span></a> for more details.</p></li>
</ul>
</div>
</div>
<div class="section" id="run">
<h2>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h2>
<p>Please follow instructions at <a class="reference internal" href="getting_started.html"><span class="doc">Getting Started</span></a> page to run an ADK sample application.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>There are two ways to update the accessory - simple update and fail safe update.</p>
<p>In simple update, the controller sends new WiFi credentials (ssid and psk) to the accessory and ADK reconfigures the
accessory to the given WiFi network.If the WiFi credentials are correct, the accessory is successfully configured to the
network. If the WiFi credentials are incorrect, the accessory will be left in that state (no rollbacks or anything). For
most real-world use cases, we will not use simple update.</p>
<p>Similarly, in fail safe update, controller sends new WiFi credentials (ssid and psk) to the accessory and ADK reconfigures
the accessory to the given WiFi network with some fail safe provisions. If the WiFi credentials are correct, ADK will
successfully configure the accessory. If Ethernet is our current transport, ADK will wait for the accessory to connect
to the new network and obtain an IP address and if everything works fine, we will set the appropriate success flags in
the update status and be done. If the WiFi reconfiguration fails to happen, we will wait for the fail safe timeout
and then rollback the WiFi configuration to the previous configuration and set the respective error flags in the update
status.</p>
<p>If WiFi is our current transport, ADK will wait for the controller to connect to the accessory over the new WiFi
network and send a commit message within fail safe update timeout after the initiation of fail safe update, which should
have the same cookie value as the cookie value passed in the fail safe update. ADK will then set the appropriate success
flags in the update status and send a write response to the controller indicating that fail safe update was successful.
If the commit message never arrives within the fail safe timeout, ADK will consider that a failure and will
rollback the configuration to the previous WiFi credentials.</p>
<p><strong>Key requirements</strong></p>
<ul class="simple">
<li><p>Accessory must support a new WiFi Transport service with a control point characteristic - WiFi Configuration control</p></li>
<li><p>Writes to the control point will trigger the four different types of operations - read configuration,
write (simple and fail safe update) configuration and a fail safe commit configuration.</p></li>
<li><p>Accessory must use the wpa supplicant control interface and use the network information configured in the
<code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf</span></code> to connect to the WiFi interface.</p></li>
</ul>
</div>
<div class="section" id="adk-implementation">
<h2>ADK Implementation<a class="headerlink" href="#adk-implementation" title="Permalink to this headline">¶</a></h2>
<p>Currently the reference implementation for WiFi reconfiguration feature is only supported for Raspberry Pi (Linux)
targets.</p>
<p>Service(s) and characteristics(s) added to ADK -</p>
<ul class="simple">
<li><p>Add a new WiFi Transport service with 3 characteristics - Current Transport, WiFi Capability and WiFi Configuration
Control.</p></li>
<li><p>Current Transport - If this is read from the accessory over a WiFi interface, it is set to true. If it is read over
Ethernet, this characteristic is set to false.</p></li>
<li><p>WiFi Capability - This characteristics is a bit mask which indicates whether the accessory supports 2.4 GHz, 5 GHz,
wake on WLAN and station mode.</p></li>
<li><p>WiFi Configuration Control - This is a control point characteristics and only admin controller can write to it which
will trigger the four different types of operations - read configuration, write (simple and fail safe update)
configuration and a fail safe commit configuration. The controller writes a TLV to the control point that contains
the operation type which is required for write requests, a cookie value which is required for write requests and
commit request, country code which is optional and station config which contains the WiFi credentials - ssid,
security mode(open network or WPA2-PSK) and psk (Not present for open network),</p></li>
</ul>
<div class="section" id="implementation-details">
<h3>Implementation details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Add service and characteristics as specified in the section above to ADK</p></li>
<li><p>Write a HAP request handler to handle reads on the 3 characteristics specified above and also handles writes on the
control point characteristics.</p></li>
<li><p>Support read configuration - Read the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant</span></code> conf file and get the persisted cookie, update status and the
network configuration (if any). Send a write response with all of the above values (set psk to empty string to indicate
presence of a PSK but not share the actual data for security reasons)</p></li>
<li><p>Support write configurations -</p></li>
</ul>
<div class="section" id="simple-update">
<h4>Simple update<a class="headerlink" href="#simple-update" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Write to the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant</span></code> conf file using the existing HAPPlatformWiFiManagerApplyConfiguration which was modified
to add a cookie value and update status. Update status is defaulted to 0.</p></li>
<li><p>Restart the WiFi interface.</p></li>
</ul>
</div>
<div class="section" id="fail-safe-update">
<h4>Fail safe update<a class="headerlink" href="#fail-safe-update" title="Permalink to this headline">¶</a></h4>
<div class="section" id="wifi-as-the-current-transport">
<h5>WiFi as the current transport<a class="headerlink" href="#wifi-as-the-current-transport" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>Decode and validate the TLV for the write request. Start a fail safe timeout timer. The fail safe timeout value can be
passed in from the controller as part of the request. Default is 60 secs.</p></li>
<li><p>Send a resource busy error if a fail safe update is already pending.</p></li>
<li><p>If we are on WiFi as the current transport, we would need to restart the accessory for the changes to take
effect. In such a case, we set the restart required flag in the update status.</p></li>
<li><p>We also set the update pending flag in the status so that if there are multiple requests, we can check if
an update is pending and return a resource busy error to other controllers.</p></li>
<li><p>Back up the existing configuration that is present in <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf</span></code> to <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf.orig</span></code> file</p></li>
<li><p>Write to the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant</span></code> using the modified <code class="docutils literal notranslate"><span class="pre">HAPPlatformWiFiManagerApplyConfiguration</span></code> api.</p></li>
<li><p>Wait for the controller to send a commit message with the same cookie value and over the new WiFi
interface before the fail safe timeout timer expires. Set the update success flag, reset all
the other flags set in update status and respond to the commit message.</p></li>
<li><p>If the commit message is not received when the fail safe timeout timer expires, rollback the WiFi
credentials to that stored in the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf.orig</span></code> file. Update the cookie value in the
<code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf</span></code> and clear the update pending and restart required flag. Set the update failed flag and
set any appropriate flags like link established, authentication failed, etc. so the controller can use it
for debugging if needed</p></li>
<li><p>If the commit message is received after the fail safe timeout has expired with the correct cookie value and
over a WiFi interface, respond to the request with the persisted cookie value and the update status.</p></li>
</ul>
</div>
<div class="section" id="ethernet-as-the-current-transport">
<h5>Ethernet as the current transport<a class="headerlink" href="#ethernet-as-the-current-transport" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>Decode and validate the TLV for the write request. Start a fail safe timeout timer. The fail safe timeout value can be
passed in from the controller as part of the request. Default is 60 secs.</p></li>
<li><p>Send a resource busy error if a fail safe update is already pending.</p></li>
<li><p>If we are on Ethernet as the current transport, we set the update pending flag in the status so that if
there are multiple requests, we can check if an update is pending and return a resource busy error to other
controllers.</p></li>
<li><p>Back up the existing configuration that is present in <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf</span></code> to <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf.orig</span></code> file</p></li>
<li><p>Write to the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant</span></code> using the modified HAPPlatformWiFiManagerApplyConfiguration api.</p></li>
<li><p>Poll the <code class="docutils literal notranslate"><span class="pre">wpa_cli</span></code> status interface to check if we are connected to the new WiFi configured in step e. and
also obtain a valid IP address on the WiFi interface and set the appropriate flags in the update status.</p></li>
<li><p>If we are successfully connected to the WiFi interface, we clear all other flags in the update status and
set the update success flag.</p></li>
<li><p>If we failed to connect to the WiFi interface or the fail safe timeout timer expires,
rollback the WiFi credentials to that stored in the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf.orig</span></code> file. Update the cookie value
in the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf</span></code> and clear the update pending and restart required flag. Set the update failed
flag and set any appropriate flags like link established, authentication failed, etc. so the controller
can use it for debugging if needed.</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="hap-modules">
<h3>HAP Modules<a class="headerlink" href="#hap-modules" title="Permalink to this headline">¶</a></h3>
<div class="section" id="source-files">
<h4>Source files<a class="headerlink" href="#source-files" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HAPServiceTypes.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HAPServiceTypes.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPCharacteristicTypes+TLV.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HAPCharacteristicTypes+TLV.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPCharacteristicTypes.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HAPCharacteristicTypes.h</span></code></p>
<ul>
<li><p>Service and characteristics information, TLVs and structs needed.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPRequestHandlers+WiFiReconfiguration.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HAPRequestHandlers+WiFiReconfiguration.h</span></code></p>
<ul>
<li><p>Request handler for handling reads and writes for all the 3 characteristics</p></li>
<li><p>Has the core logic of this feature and calls PAL APIs from WiFi manager to accomplish the above</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="pal-modules">
<h3>PAL Modules<a class="headerlink" href="#pal-modules" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformTCPStreamManager.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HAPPlatformTCPStreamManager.h</span></code></p>
<ul>
<li><p>APIs added for detecting if WiFi or Ethernet is the current transport and also the WiFi capabilities of the
accessory</p>
<ul>
<li><p>HAPPlatformTCPStreamManagerIsWiFiCurrentTransport - Returns true if the current transport used by the socket
of the receive TCP stream manager instance is WiFi. False otherwise.</p></li>
<li><p>HAPPlatformTCPStreamManagerGetWiFiCapability - Returns the supported Wi-Fi capabilities.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPPlatformWiFiManager.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HAPPlatformWiFiManager.h</span></code></p>
<ul>
<li><p>Added APIs for saving the WiFi credentials to the <code class="docutils literal notranslate"><span class="pre">wpa_supplicant</span></code>, getters and setters for the cookie value, update
status, getters for ssid and to check if psk is configured, backup the configuration to <code class="docutils literal notranslate"><span class="pre">wpa_supplicant.conf.orig</span></code>,
restore the WiFi credentials from the backed up configuration and clear the configuration.</p>
<ul>
<li><p>HAPPlatformWiFiManagerGetCookie - Get the cookie value persisted in the wpa supplicant.</p></li>
<li><p>HAPPlatformWiFiManagerSetCookie - Set the cookie value to be persisted in the wpa supplicant.</p></li>
<li><p>HAPPlatformWiFiManagerGetUpdateStatus - Get the updateStatus value persisted in the wpa supplicant.</p></li>
<li><p>HAPPlatformWiFiManagerSetUpdateStatus - Sets the updateStatus value in the wpa supplicant to the new value.</p></li>
<li><p>HAPPlatformWiFiManagerIsPSKConfigured - Checks if PSK is configured in the wpa supplicant.</p></li>
<li><p>HAPPlatformWiFiManagerBackUpConfiguration - Backs up the Wi-Fi network configuration.</p></li>
<li><p>HAPPlatformWiFiManagerIsWiFiLinkEstablished - Parses the wpa_status result returned using the wpa_cli status
command and returns true if wpa state is connected.</p></li>
<li><p>HAPPlatformWiFiManagerIsWiFiNetworkConfigured - Parses the wpa_status result returned using the wpa_cli status
command and returns true if ip address is obtained.</p></li>
<li><p>HAPPlatformWiFiManagerClearConfiguration - Clear the configuration and remove all network configurations (Used
by WAC code as well)</p></li>
</ul>
</li>
<li><p>Modified APIs</p>
<ul>
<li><p>HAPPlatformWiFiManagerApplyConfiguration - Added parameters cookie value, update status and a flag to
indicate if we should restart the WiFi interface or not.</p></li>
<li><p>HAPPlatformWiFiManagerRestartWiFi - Using wpa_cli reconfigure command to restart the WiFi interface.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="testing-wifi-reconfiguration">
<h3>Testing WiFi Reconfiguration<a class="headerlink" href="#testing-wifi-reconfiguration" title="Permalink to this headline">¶</a></h3>
<p>We can test some basic use cases for Wifi Reconfiguration by using the HAT tool. Below are the instructions on how
to do so.</p>
<ul class="simple">
<li><p>Run the Lightbulb accessory after compiling it with the appropriate flags to enable the WiFi reconfiguration
feature.</p></li>
<li><p>Open the Home Accessory Tester tool and Discover the services and characteristics of the Lightbulb accessory.</p></li>
<li><p>Navigate to the Wi-Fi Configuration Control characteristics on the left pane.</p></li>
<li><p>Go to Prepare and Execute Timed Write [tlv8] on the right side. Click on Build TLV.</p></li>
<li><p>You can choose the Operation Type - Read, Simple Update, Fail Safe Update and Commit for fail safe update.</p></li>
</ul>
<div class="section" id="different-use-cases-to-test">
<h4>Different use cases to test<a class="headerlink" href="#different-use-cases-to-test" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Read configuration - Nothing else needs to be filled in. Click Build TLV. That should populate the Prepare and
Execute Timed Write [tlv8]. Click on Timed Write. On the terminal running the accessory, you should be able to
see the current WiFi configuration.</p></li>
<li><p>Simple update configuration - Need to put in a cookie value that should be unique for this request, country code
e.g. - “US”, SSID, Choose the security mode, if WPA-PSK is chosen, either enter the plain text passphrase or
PSK. Click Build TLV. That should populate the Prepare and Execute Timed Write [tlv8]. Click on Timed Write.
On the terminal running the accessory, you should be able to see the new WiFi Reconfiguration get applied.</p></li>
<li><p>Fail safe update configuration (Ethernet as current transport) - Need to put in a cookie value that should be
unique for this request, country code e.g. - “US”, SSID, Choose the security mode, if WPA-PSK is chosen, either
enter the plain text passphrase/PSK. Click Build TLV. That should populate the Prepare and Execute Timed Write
[tlv8]. Click on Timed Write. On the terminal running the accessory, you should be able to see the new WiFi
Reconfiguration get applied. If your WiFi credentials are incorrect or network is unreachable or a failure
happens, we will rollback to the old valid WiFi credentials.</p></li>
<li><p>Fail safe update configuration (WiFi as current transport) - Configure the Raspberry pi on a WiFi network and
disconnect the Ethernet cable. Make sure you can see the Lightbulb advertising on Bonjour.
Need to put in a cookie value that should be unique for this request, country code e.g. - “US”, SSID, Choose the
security mode, if WPA-PSK is chosen, either enter the plain text passphrase/PSK. Click Build TLV. That should
populate the Prepare and Execute Timed Write [tlv8]. Click on Timed Write. On the terminal running the accessory,
you should be able to see the new WiFi Reconfiguration get applied. For WiFi as current transport, we need to
send the Commit message within 30 secs of sending the fail safe update request. As soon as the accessory comes
back on HAT on the new network, choose the Commit configuration operation type and choose the cookie value that
matches the one sent for the fail safe update. Only then the WiFi configuration will succeed otherwise it will
fail. If your WiFi credentials are incorrect or network is unreachable or a failure happens, we will rollback to
the old valid WiFi credentials.</p></li>
</ul>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="_api_docs/dir_PAL.html" class="btn btn-neutral float-right" title="Directory PAL" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="Thread_Use_Case_Flows.html" class="btn btn-neutral float-left" title="Thread Use Cases" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright © 2021 Apple Inc. All Rights Reserved..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>