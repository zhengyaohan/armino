

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Adaptive Lighting Service &mdash; HomeKit ADK  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/tabs.js"></script>
        <script src="_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Apple TV Remote" href="appletv_remote.html" />
    <link rel="prev" title="Accessory Metrics Service" href="accessory_metrics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> HomeKit ADK
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="adk_architecture.html">ADK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="adk_directory_structure.html">ADK Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker with ADK</a></li>
</ul>
<p class="caption"><span class="caption-text">Step-by-step Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="raspi_setup.html">Raspberry Pi Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="bct.html">Bonjour Conformance Test (BCT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wac_on_raspberrypi.html">WAC on Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera_on_darwin.html">Camera on macOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting ADK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interact_with_applications.html">Interacting with ADK applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_unit_tests.html">Writing Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_adk.html">Debugging ADK Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">ADK Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accessory_development.html">Accessory Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_pairing.html">Accessory Pairing</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_authentication.html">Accessory Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning_tools.html">Provisioning Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="ADK_Memory_Usage_and_Requirements.html">Memory Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptographic Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="make_options.html">Compile Time Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_convention.html">Coding Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration_guide.html">ADK Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">HomeKit Services</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="accessory_diagnostics.html">Accessory Diagnostics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_metrics.html">Accessory Metrics Service</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Adaptive Lighting Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compile">Compile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run">Run</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementation-details">Implementation Details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#assumptions">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#terminology">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-information">Additional Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#app-implementation">App Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="appletv_remote.html">Apple TV Remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="firmware_update.html">Firmware Update Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="homekit_bridge.html">HomeKit Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="ip_camera.html">IP Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="lock_profile.html">Lock Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="stateless_programmable_switch.html">Stateless Programmable Switch</a></li>
<li class="toctree-l1"><a class="reference internal" href="thread.html">HAP over Thread Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="wifi_reconfiguration_feature.html">WiFi Reconfiguration Service</a></li>
</ul>
<p class="caption"><span class="caption-text">PAL APIs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_api_docs/dir_PAL.html">Directory PAL</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">HomeKit ADK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Adaptive Lighting Service</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/adaptive_light.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="adaptive-lighting-service">
<h1>Adaptive Lighting Service<a class="headerlink" href="#adaptive-lighting-service" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This document describes the Adaptive Lighting feature provided by the ADK and how to integrate it into a HomeKit
accessory. This feature enables HomeKit-based accessories to change Brightness and Color Temperature based on a given
schedule. Please refer to <em>Light Shift Requirements</em> section of HomeKit Accessory Protocol Specification for more
details.</p>
<div class="section" id="compile">
<h3>Compile<a class="headerlink" href="#compile" title="Permalink to this headline">¶</a></h3>
<p>You must have all the <a class="reference internal" href="getting_started.html"><span class="doc">prerequisites</span></a> for your development platform to compile the ADK. Once all the
prerequisites are installed for your platform, run the following to compile ADK with adaptive lighting feature:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-bWFjT1M=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="0">macOS</button><button aria-controls="panel-0-TGludXg=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-TGludXg=" name="TGludXg=" role="tab" tabindex="-1">Linux</button><button aria-controls="panel-0-UmFzcGJlcnJ5IFBp" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tab" tabindex="-1">Raspberry Pi</button><button aria-controls="panel-0-Tm9yZGljIG5SRjUy" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tab" tabindex="-1">Nordic nRF52</button></div><div aria-labelledby="tab-0-bWFjT1M=" class="sphinx-tabs-panel group-tab" id="panel-0-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Darwin <span class="nv">HAP_ADAPTIVE_LIGHT</span><span class="o">=</span><span class="m">1</span> <span class="nv">APPS</span><span class="o">=</span>Lightbulb
</pre></div>
</div>
</div><div aria-labelledby="tab-0-TGludXg=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Linux <span class="nv">HAP_ADAPTIVE_LIGHT</span><span class="o">=</span><span class="m">1</span> <span class="nv">APPS</span><span class="o">=</span>Lightbulb
</pre></div>
</div>
</div><div aria-labelledby="tab-0-UmFzcGJlcnJ5IFBp" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-UmFzcGJlcnJ5IFBp" name="UmFzcGJlcnJ5IFBp" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>Raspi <span class="nv">HAP_ADAPTIVE_LIGHT</span><span class="o">=</span><span class="m">1</span> <span class="nv">APPS</span><span class="o">=</span>Lightbulb
</pre></div>
</div>
</div><div aria-labelledby="tab-0-Tm9yZGljIG5SRjUy" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-Tm9yZGljIG5SRjUy" name="Tm9yZGljIG5SRjUy" role="tabpanel" tabindex="0"><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">TARGET</span><span class="o">=</span>nRF52 <span class="nv">HAP_ADAPTIVE_LIGHT</span><span class="o">=</span><span class="m">1</span> <span class="nv">APPS</span><span class="o">=</span>Lightbulb
</pre></div>
</div>
</div></div>
</div>
<div class="section" id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p>Please follow instructions at <a class="reference internal" href="getting_started.html"><span class="doc">Getting Started</span></a> page to run Lightbulb sample application.</p>
</div>
</div>
<div class="section" id="implementation-details">
<h2>Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>HomeKit controller configures Characteristic Transition Schedule after querying Supported Transitions Settings
from the accessory. If proposed Transition Configuration is valid, the accessory will accept it and start executing
immediately. The accessory is expected to update respective characteristic value based on schedule and notify
controllers once transition schedule is complete.</p>
<div class="section" id="assumptions">
<h3>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Number of Supported Transition Points: 52</p>
<ul>
<li><p>This is the number of transition points supported across all transitions. It is not the number of transition points
supported per transition.</p></li>
<li><p>The number of transition points required may increase in the future, and vendors shall adjust the value based on
features supported by accessories.</p></li>
</ul>
</li>
<li><p>Number of Supported Transitions: 2</p></li>
<li><p>Size of Controller Context: 255 bytes</p></li>
<li><p>Data type for storing characteristic value: int32_t</p></li>
<li><p>Data type for storing HAP Instance ID: uint64_t</p></li>
<li><p>Vendors can reduce memory usage:</p>
<ul>
<li><p>If they support transition for one characteristic only.</p></li>
<li><p>If they use fewer bytes to represent HAP instance ID in their application.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="terminology">
<h3>Terminology<a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><em>Transition</em>: A curve describing change in characteristic value over time.</p></li>
<li><p><em>Transition point</em>: A point on the transition curve describing change relative to the previous point.</p></li>
<li><p><em>Linear Transition</em>: Transition where value of the given characteristic is independent of any other characteristics.</p></li>
<li><p><em>Linear Derived Transition</em>: Transition where value of the given characteristic depends on value of some other
characteristic.</p></li>
<li><p><em>Loop</em>: End Behavior where Transition repeats itself after last transition point is complete.</p></li>
</ul>
</div>
<div class="section" id="additional-information">
<h3>Additional Information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h3>
<p>Please follow below steps to use this feature in your accessory:</p>
<ul class="simple">
<li><p>Include <em>AdaptiveLight.h</em> in your application.</p></li>
<li><p>Advertise appropriate range for Brightness/Color Temperature characteristic.</p></li>
<li><p>Define permanent storage for Adaptive Light feature, ie a static instance of type <code class="docutils literal notranslate"><span class="pre">AdaptiveLightTransitionStorage</span></code>.</p></li>
<li><p>Implement callback methods <code class="docutils literal notranslate"><span class="pre">handleCharacteristicValueUpdate</span></code>, <code class="docutils literal notranslate"><span class="pre">handleTransitionExpiry</span></code>,
<code class="docutils literal notranslate"><span class="pre">handleCharacteristicValueRequest</span></code>.</p></li>
<li><p>Invoke <code class="docutils literal notranslate"><span class="pre">InitializeAdaptiveLight()</span></code> with appropriate parameters during application initialization.</p></li>
<li><p>Invoke <code class="docutils literal notranslate"><span class="pre">RemoveTransition()</span></code> during write handler of a characteristic if it is in middle of a transition.</p></li>
</ul>
</div>
<div class="section" id="app-implementation">
<h3>App Implementation<a class="headerlink" href="#app-implementation" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p><em>Applications/LightBulb/AdaptiveLight.h</em>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">AdaptiveLightTransitionStorage</span></code>: The persistent storage for Transition configuration and context.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">AdaptiveLightTransition</span></code>: A common structure used to represent Linear and Linear Derived Transitions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">AdaptiveLightTransitionPoint</span></code>: A common structure used to represent Linear and Linear Derived Transition
points.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">AdaptiveLightCallbacks</span></code>: A collection of callback functions to be implemented by the Application.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">AdaptiveLightRuntimeContext</span></code>: Runtime context required to remember write response type.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">InitializeAdaptiveLightParameters()</span></code>: Function to configure storage, callback function, and supported transition
types.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Initialize Adaptive Light Storage</span>
<span class="cm"> *</span>
<span class="cm"> * @param      adaptiveLight            Pointer to Persistent Storage</span>
<span class="cm"> * @param      supportedTransitions     Supported Transitions</span>
<span class="cm"> * @param      numSupportedTransitions  Number of Supported Transitions</span>
<span class="cm"> * @param      callback                 Callbacks to be invoked for requests and notifications</span>
<span class="cm"> *</span>
<span class="cm"> * @return kHAPError_None           If successful.</span>
<span class="cm"> * @return kHAPError_OutOfResources If number of requested transitions is more than supported.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">HAP_RESULT_USE_CHECK</span><span class="w"></span>
<span class="n">HAPError</span><span class="w"> </span><span class="n">InitializeAdaptiveLightParameters</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">HAPPlatformKeyValueStoreRef</span><span class="w"> </span><span class="n">keyValueStore</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">AdaptiveLightTransitionStorage</span><span class="o">*</span><span class="w"> </span><span class="n">adaptiveLight</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">AdaptiveLightSupportedTransition</span><span class="o">*</span><span class="w"> </span><span class="n">supportedTransitions</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">numSupportedTransitions</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">AdaptiveLightCallbacks</span><span class="o">*</span><span class="w"> </span><span class="n">callbacks</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPHandleSupportedTransitionConfigurationRead()</span></code>: Read handler for supported Transition Configuration
characteristic.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPHandleTransitionControlRead()</span></code>/<code class="docutils literal notranslate"><span class="pre">HAPHandleTransitionControlWrite()</span></code>: Read/Write handler for Transition Control
characteristic.</p></li>
<li><p>Callback methods to be implemented by the Application:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Callback function invoked when characteristic value changes during transition.</span>
<span class="cm"> *</span>
<span class="cm"> * @param characteristicID   HAP Instance ID of the characteristic.</span>
<span class="cm"> * @param value              New value</span>
<span class="cm"> * @param sendNotification   Boolean to indicate if app should notify controller of value change</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">handleCharacteristicValueUpdate</span><span class="p">)(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">characteristicID</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">sendNotification</span><span class="p">);</span><span class="w"></span>
<span class="cm">/**</span>
<span class="cm"> * Callback function invoked when a transition gets over.</span>
<span class="cm"> *</span>
<span class="cm"> * @param characteristicID   HAP Instance ID of the characteristic.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">handleTransitionExpiry</span><span class="p">)(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">characteristicID</span><span class="p">);</span><span class="w"></span>
<span class="cm">/**</span>
<span class="cm"> * Callback function invoked to obtain current value of given characteristic.</span>
<span class="cm"> *</span>
<span class="cm"> * @param characteristicID   HAP Instance ID of the characteristic.</span>
<span class="cm"> * @param value              Output value</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">handleCharacteristicValueRequest</span><span class="p">)(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">characteristicID</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><em>Applications/Common/Helper/AdaptiveLight.c</em>:
This file contains source code for characteristic read/write handlers, transition value calculations, and characteristic
transitions.</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="appletv_remote.html" class="btn btn-neutral float-right" title="Apple TV Remote" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="accessory_metrics.html" class="btn btn-neutral float-left" title="Accessory Metrics Service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright © 2021 Apple Inc. All Rights Reserved..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>