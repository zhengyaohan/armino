

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Accessory Pairing &mdash; HomeKit ADK  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Accessory Authentication" href="accessory_authentication.html" />
    <link rel="prev" title="Accessory Development" href="accessory_development.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> HomeKit ADK
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="adk_architecture.html">ADK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="adk_directory_structure.html">ADK Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker with ADK</a></li>
</ul>
<p class="caption"><span class="caption-text">Step-by-step Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="raspi_setup.html">Raspberry Pi Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="bct.html">Bonjour Conformance Test (BCT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wac_on_raspberrypi.html">WAC on Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera_on_darwin.html">Camera on macOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting ADK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interact_with_applications.html">Interacting with ADK applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting ADK</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_unit_tests.html">Writing Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_adk.html">Debugging ADK Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">ADK Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="accessory_development.html">Accessory Development</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Accessory Pairing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pairing">Pairing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wi-fi-accessory-configuration">Wi-Fi Accessory Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="accessory_authentication.html">Accessory Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning_tools.html">Provisioning Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="ADK_Memory_Usage_and_Requirements.html">Memory Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptographic Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="make_options.html">Compile Time Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_convention.html">Coding Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration_guide.html">ADK Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">HomeKit Services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accessory_diagnostics.html">Accessory Diagnostics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessory_metrics.html">Accessory Metrics Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="adaptive_light.html">Adaptive Lighting Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="appletv_remote.html">Apple TV Remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="firmware_update.html">Firmware Update Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="homekit_bridge.html">HomeKit Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="ip_camera.html">IP Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="lock_profile.html">Lock Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="stateless_programmable_switch.html">Stateless Programmable Switch</a></li>
<li class="toctree-l1"><a class="reference internal" href="thread.html">HAP over Thread Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="wifi_reconfiguration_feature.html">WiFi Reconfiguration Service</a></li>
</ul>
<p class="caption"><span class="caption-text">PAL APIs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="_api_docs/dir_PAL.html">Directory PAL</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">HomeKit ADK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Accessory Pairing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/accessory_pairing.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="accessory-pairing">
<h1>Accessory Pairing<a class="headerlink" href="#accessory-pairing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="pairing">
<h2>Pairing<a class="headerlink" href="#pairing" title="Permalink to this headline">¶</a></h2>
<p>A HomeKit controller can only use a HomeKit accessory after it has been paired with it. A new HomeKit accessory, or an
accessory that has been factory reset, is not paired with any HomeKit controller. An accessory can be paired after it
has been powered on. A Wi-Fi accessory needs to be in <a class="reference external" href="#wi-fi-accessory-configuration">WAC Mode</a> for pairing, or must be
added to the Wi-Fi network out-of-band.</p>
<p>If an accessory has a display that supports showing a setup code, a random setup code is used while pairing. Note that
for displays that support showing a scannable QR code it is still necessary to provision each accessory with a unique
setup ID during manufacturing. This setup ID is used for identifying the accessory. The ADK will call the
<code class="docutils literal notranslate"><span class="pre">HAPPlatformAccessorySetupDisplay</span></code> function for updating the setup code, and when the pairing is started and stopped.</p>
<p>If the accessory has a programmable NFC tag, accessory setup information may be exchanged over NFC. The platform
<code class="docutils literal notranslate"><span class="pre">HAPPlatformAccessorySetupNFC</span></code> function must be implemented if the accessory has a programmable NFC tag.</p>
<ul class="simple">
<li><p>Programmable NFC requires the accessory to be provisioned with a setup ID. If no display is available, the raw setup
code must also be provisioned.</p></li>
<li><p>In contrast to displays that are activated automatically when a pairing request is registered, programmable NFC is
only available after explicitly calling <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerEnterNFCPairingMode</span></code>.</p></li>
<li><p>The accessory must require users to explicitly trigger NFC pairing mode via a physical interaction on the accessory.</p></li>
<li><p>Accessories implementing programmable NFC must not implicitly be ready to pair once all pairings have been removed.</p></li>
</ul>
<p>For debugging the pairing behavior of IP accessories, it can be helpful to observe the Bonjour TXT status flags
(see also <em>Table 6-9 Bonjour TXT Status Flags in the HAP specification</em>) using a Bonjour browser app such as Discovery
from the App Store. These flags, which are broadcast over the IP network, are also shown in the ADK log output:</p>
<ul class="simple">
<li><p>The value of <em>sf</em> should be <em>1</em> if the accessory is not paired. In this case, the accessory should be visible in the
Add accessory screen of the HomeKit controller.</p></li>
<li><p>The value of <em>sf</em> should be <em>0</em> if the accessory is paired.</p></li>
</ul>
<p>For accessories that support displays or programmable NFC, it is the accessory manufacturer’s responsibility to provide
an appropriate mechanism for entering this special mode. The mechanism must require physical presence of a user, so that
no remote attacks can cause the pairing mode to be entered. Typically, a dedicated hardware button is provided that
enables NFC pairing for a limited time.</p>
<p>The following is required for licensed accessories:</p>
<ul class="simple">
<li><p>The accessory must require users to explicitly trigger NFC pairing mode via a physical interaction.</p></li>
<li><p>Accessories implementing programmable NFC must not implicitly be ready to pair once pairing is removed.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When the user initiates a manual pairing in the Home app’s accessory browser (list of unpaired HomeKit accessories),
the HAP Library automatically enters the pairing mode without further user intervention. This behavior must be
modified for programmable NFC tags when going through production to require user interaction in this case, i.e.,
by not running <cite>HAPAccessoryServerStart</cite> until the user triggers NFC pairing mode.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The NFC pairing mode is triggered automatically after every power cycle (switching accessory off and on again).
This workaround is only intended for testing and debugging. For actual products, the pairing mode has to be
implemented by the accessory logic. The samples by default turn on pairing mode for the first few minutes after
power on, however that behavior can be changed easily in the AppBase.c / App.c files. It is expected that licensees
adjust the code so that pairing mode is wired to a physical button instead of simply being present upon power on.</p>
</div>
<p>Currently applicable to Wi-Fi Routers only: ADK 3.0 onwards includes support for ownership proofs. When an accessory is
paired through a non-HomeKit mechanism, ownership proof can be used to restrict HomeKit pairing to users who have the
necessary privileges in said non-HomeKit system. Ownership proof requires an accessory app that can obtain a software
token from the accessory which proves that the user is authorized to perform HomeKit pairing. Please refer to the
documentation of the APIs <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerSetOwnershipProofTokenRequired</span></code> and
<code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerGenerateOwnershipProofToken</span></code> in <code class="docutils literal notranslate"><span class="pre">HAP.h</span></code>.</p>
<p>Example flow:</p>
<ol class="simple">
<li><p>User requests HomeKit pairing in accessory app.</p></li>
<li><p>Accessory app communicates with the accessory and verifies that the user is authorized for HomeKit pairing.</p></li>
<li><p>Accessory generates ownership proof token using <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerGenerateOwnershipProofToken</span></code>.</p></li>
<li><p>Accessory app obtains the generated ownership proof token from the accessory.</p></li>
<li><p>Accessory app provides the ownership proof token using <code class="docutils literal notranslate"><span class="pre">[HMAccessorySetupPayload</span> <span class="pre">initWithURL:ownershipToken:]</span></code>.</p></li>
<li><p>Accessory app requests HomeKit pairing using <code class="docutils literal notranslate"><span class="pre">[HMHome</span> <span class="pre">addAndSetupAccessoriesWithPayload:completionHandler:]</span></code>.</p></li>
<li><p>During the HomeKit pairing process, the app-provided ownership proof token is sent to the accessory.</p></li>
<li><p>Accessory verifies that the received ownership proof token matches the one generated earlier.</p></li>
<li><p>After HomeKit pairing completes, user gains HomeKit admin privileges.</p></li>
</ol>
</div>
<div class="section" id="wi-fi-accessory-configuration">
<h2>Wi-Fi Accessory Configuration<a class="headerlink" href="#wi-fi-accessory-configuration" title="Permalink to this headline">¶</a></h2>
<p>A HomeKit Wi-Fi accessory that has not been used yet, or has been reset to factory settings, has no information on how
to join the owner’s Wi-Fi network, i.e., no network name (SSID) nor the password. HomeKit uses the <em>WAC2</em> protocol to
provide this information to the accessory during pairing, without the user having to enter the information manually.</p>
<p>The WAC process goes through several states. Knowing them can help during testing of an accessory. The following diagram
shows the WAC state machine as implemented in the ADK:</p>
<p><img alt="WAC Process" src="_images/wac.png" /></p>
<ul class="simple">
<li><p>Idle state:
An unpaired accessory goes into the Idle state after booting up and after HAPAccessoryServerCreate has been called by
the accessory logic. This is the only state in which the accessory logic is allowed to call HAPAccessoryServerStart,
which transitions the accessory into the Running state.</p></li>
<li><p>Running state:
The Running state has three sub-states: HAP Mode, WAC Mode and Not Configured. If the Wi-Fi credentials are already
configured, which might have happened with some mechanism other than WAC on accessories that do not only support
HomeKit, or if the accessory logic has set the <code class="docutils literal notranslate"><span class="pre">ip.wac.available</span></code> flag in the <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerOptions</span></code> to false, the
accessory enters HAP Mode when started.</p>
<ul>
<li><p>HAP Mode sub-state is the normal operational state when an accessory is running.</p></li>
<li><p>WAC Mode sub-state is entered automatically when the server has been created for an un-configured accessory, or
when a user requests it explicitly: typically via a hardware button. If no successful configuration occurs for 15
minutes, the accessory goes into the Not Configured mode, otherwise into HAP Mode. An accessory’s user interface may
also allow the user to explicitly exit WAC Mode, e.g., by pressing the WAC button again.</p></li>
<li><p>Not Configured sub-state is entered after 15 minutes if no successful configuration occurred. The user can request
the accessory to re-enter WAC Mode.</p></li>
</ul>
</li>
<li><p>Stopping state:
When <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerStop</span></code> is called by the accessory logic, the accessory enters the Stopping state. In this state,
pending HAP requests are processed, but no new requests are accepted anymore. A timeout ensures that the Idle state is
entered eventually even if outstanding requests cannot be completed for some reason.</p></li>
</ul>
<p>Some remarks regarding the accessory server functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerStop</span></code> may be called anytime after <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerCreate</span></code>. It always causes a state transition
to Stopping if not in Idle, or it remains idle if already in Idle state. This can be useful e.g. for setting up the
Wi-Fi credentials through some other mechanism, see below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerStart</span></code> may only be called in Idle state, otherwise a precondition check fails.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerEnterWACMode</span></code> may be called anytime after <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerCreate</span></code>. It has no effect, except if
in HAP Mode, where it deletes the Wi-Fi credentials and transitions to WAC Mode.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerExitWACMode</span></code> may be called anytime after <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerCreate</span></code>. It has no effect, except if
in WAC Mode, where it transitions to HAP Mode or Not Configured, depending on whether or not the Wi-Fi network has been
configured in the meantime by an out-of-band mechanism.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerIsInWACMode</span></code> indicates whether the accessory is currently in the WAC Mode sub-state of state
Running. Relevant state changes are also signaled through the <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerCallbacks.handleUpdatedState</span></code> callback.
Also refer to <code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerGetState</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a Wi-Fi configuration has been applied through an out-of-band mechanism (not via WAC), it is necessary to call
<code class="docutils literal notranslate"><span class="pre">HAPAccessoryServerExitWACMode</span></code>. The accessory server will then enter normal HAP mode.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="accessory_authentication.html" class="btn btn-neutral float-right" title="Accessory Authentication" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="accessory_development.html" class="btn btn-neutral float-left" title="Accessory Development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright © 2021 Apple Inc. All Rights Reserved..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>